import os
import base64

from flask import Flask, request, jsonify, render_template
from dotenv import load_dotenv
from openai import OpenAI

# ===============================
# Load API Key
# ===============================
load_dotenv()
API_KEY = os.getenv("OPENAI_API_KEY")

client = OpenAI(api_key=API_KEY)

app = Flask(__name__)

# ===============================
# API Key Check
# ===============================
@app.route("/ping-key")
def ping_key():
    return {"has_key": bool(API_KEY)}

# ===============================
# Home Page
# ===============================
@app.route("/")
def home():
    return render_template("coach.html")


# ===============================
# IMAGE Q&A ENDPOINT
# ===============================
@app.route("/image-ask", methods=["POST"])
def image_ask():
    try:
        # Check for image
        if "image" not in request.files:
            return jsonify({"error": "No image uploaded"}), 400

        image_file = request.files["image"]

        # User-added instructions
        user_prompt = request.form.get("question", "").strip()

        # Base instructions for all images
        base_instruction = (
            "Read all the text in the image. "
            "If the image contains a question, answer it directly and clearly. "
            "Do NOT describe the picture. "
        )

        # Combine user requests with default instruction
        if user_prompt:
            final_prompt = base_instruction + "User request: " + user_prompt
        else:
            final_prompt = base_instruction + "Give the answer now."

        # Convert image â†’ base64
        image_bytes = image_file.read()
        img_b64 = base64.b64encode(image_bytes).decode("utf-8")
        data_url = f"data:image/jpeg;base64,{img_b64}"

        # Call OpenAI Vision model
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "user",
                 "content": [
                     {"type": "text", "text": final_prompt},
                     {"type": "image_url", "image_url": {"url": data_url}}
                 ]}
            ],
        )

        ai_answer = response.choices[0].message.content
        return jsonify({"answer": ai_answer})

    except Exception as e:
        return jsonify({"error": str(e)}), 500


# ===============================
# NORMAL TEXT CHAT ENDPOINT
# ===============================
@app.route("/text-chat", methods=["POST"])
def text_chat():
    try:
        user_text = request.form.get("message", "").strip()

        if not user_text:
            return jsonify({"error": "Empty message"}), 400

        # Standard model call
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "user", "content": user_text}
            ],
        )

        ai_reply = response.choices[0].message.content
        return jsonify({"answer": ai_reply})

    except Exception as e:
        return jsonify({"error": str(e)}), 500


# ===============================
# Run server (optional)
# ===============================
# if __name__ == "__main__":
#     app.run(host="0.0.0.0", port=5020, debug=True)

